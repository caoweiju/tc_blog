---
title: 移动端Web元素进入可视区曝光的优雅处理实践
date: 2020-01-15 15:37:11
tags:
- debug
categories: 
- tool
---

## 曝光
在移动端的产品设计中，很多广告和流量都比较关心产品的曝光度，对于开发人员而言，处理曝光的确是一个比较棘手的问题；特别是开发人员对于曝光的定义，常见于以下几种：

- 进入过可视区的数据，无论是否停留，即使快速滑过也需要计算
- 用户视觉上有所停留的数据，必须是在可视区停留过的元素才算

这样不同的要求就需要不同的实现处理；

<!-- more -->

## 常见处理

目前对于web端而言，曝光比较常见的是依赖滑动scroll来处理的；

### 简单方案一：滚动停止后计算当前最后一个元素，然后将之前的元素全部曝光
实现思路：
1. 监听滚动事件，并添加防抖，仅在停止滚动后触发行为
2. 滚动停止后，检测滑动距离offset；
3. 根据滚动距离offset计算当前可视区底部的元素；【要求元素高度不响应式，最好是list嵌套高度一致的item】
4. 上报底部元素之前的元素；【可以选择是全部曝光还是仅曝光当前可视区高度内的元素】
5. 记录曝光内容，防止多次曝光

*本方案注意：仅适用于元素的高度不能响应式变动，而且是list类型的高度一致的子元素*

### 适中方案二：需要曝光的元素单独添加监控，滚动停止后遍历元素，找到在可视区的元素，完成曝光，并设置曝光标志，避免重复曝光
实现思路：
1. 将需要曝光的元素添加监控，并初始化添加元素的偏移量，用于后续判断是否在可视区，并将元素按照顺序的放进待曝光池数组中；
2. 监听滚动事件，并添加防抖，仅在停止滚动后触发行为；
3. 遍历元素，根据元素的偏移量和整体的滚动距离来判断是否在可视区，并完成曝光，并从曝光池数组清除该元素；
4. 优化滚动停止后，如何快速检测当前可视区域的元素，避免滚动停止后的重复无效遍历；

*本方案注意：需要注意检测当前可视区元素方法*

## IntersectionObserver优雅实践




参考：https://www.zhihu.com/question/67328049 and https://developer.mozilla.org/zh-CN/docs/Web/API/IntersectionObserver and https://www.smashingmagazine.com/2018/01/deferring-lazy-loading-intersection-observer-api/
